{% extends "base.html" %}
{% block body %}

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">

  google.charts.load('current', {'packages':['corechart', 'line']});
  google.charts.setOnLoadCallback(drawChart);

  function drawChart() {

    var dataJSON = '{{ data|tojson }}';
    var dataSplit = dataJSON.split(',');

    const dates = new Array();
    const prices = new Array();
    for (var i = 0; i < dataSplit.length; i++) {
      var curData = dataSplit[i];
      var curDataSplit = curData.split(':');

      if (i === 0 || i === (dataSplit.length) - 1) {
        if (i === 0) {
          var firstPart = curDataSplit[0];
          var splitFirst = firstPart.split('{');
          dates.push(splitFirst[1]);
          prices.push(curDataSplit[1]);
        } else {
          var firstPart = curDataSplit[1];
          var splitFirst = firstPart.split('}');
          dates.push(curDataSplit[0]);
          prices.push(splitFirst[0]);
        }
      } else {
        dates.push(curDataSplit[0]);
        prices.push(curDataSplit[1]);
      }
    }

    const datesFormatted = new Array();
    const pricesFormatted = new Array();
    for (var k = 0; k < dates.length; k++) {
      var curDate = dates[k];
      var splitDate = curDate.split('-');
      if (k === 0) {
        var year = splitDate[0].substring(1, 6);
        var newDate = new Date(splitDate[0].substring(1, 6), splitDate[1] - 1, splitDate[2].substring(0, 2));
        datesFormatted.push(newDate);
      } else {
        var year = splitDate[0].substring(2, 6);
        var newDate = new Date(splitDate[0].substring(2, 6), splitDate[1] - 1, splitDate[2].substring(0, 2));
        datesFormatted.push(newDate);
      }
      var priceCur = prices[k];
      var subPrice = priceCur.substring(2, priceCur.length - 1);
      var priceC = (Number(subPrice));
      pricesFormatted.push(priceC);
    }

    var data = new google.visualization.DataTable();
    data.addColumn('date', 'Date');
    data.addColumn('number', 'Price');

    for (var m = 0; m < datesFormatted.length; m++) {
      data.addRow([datesFormatted[m], pricesFormatted[m]]);
    }

    var dataCount = datesFormatted.length;

    var options = {
      title: 'Asset Performance (Past Month)',
      pointsVisible: true,
      pointSize: 3,
      legend: {position: 'none'},
      hAxis: {
        format: 'MM/d',
        gridlines: {count: 5},
        pointSize: 2,
        //title: 'Date',
        titlePosition: 'none'
      },
      vAxis: {
        title: 'Price'
      }
    };

    var curPrice = pricesFormatted[pricesFormatted.length - 1];
    console.log('CUR PRICE: ' + curPrice);
    document.getElementById("myText").innerHTML = curPrice;

    var chart = new google.visualization.LineChart(document.getElementById("curve_chart"));

    console.log("Results data: ");
    console.log(data);
    chart.draw(data, options);
  }
  console.log("Script");
</script>


{% if query %}
  {% for r in query %}
  {% endfor %}
  <ul>
    <li>{{ query[0] }}</li>
    <li>{{ query[1] }}</li>
    <li>{{ query[2] }}</li>
  </ul>
  <style>
    ul {
      list-style-type: none;
      color:blue;
      font-weight: bold;
    }
  </style>
{% else %}
  <p> Please enter a ticker to search for.. </p>
{% endif %}
  <p>
    <div id="curve_chart" class ="chart" style="width: 900px; height: 500px"></div>
    <style>
    .chart {
      width: auto;
      margin: 0 auto;
    }
    </style>
    <br>
    <p class="priceSymbol">Current Price: $<span id="myText"></span></p>
    <style>
      .priceSymbol {
        color:green;
      }
    </style>
    <br>
    <p class="desc">{{ query[3] }} </p>
    <style>
      .desc {
        padding-left: 50px;
        padding-right: 50px;
        color:black;
      }
    </style>
  </p>
{% endblock %}
